---

- name: catalog_batch_upsert
  uri:
    url: "https://connect.squareup.com/v2/catalog/batch-upsert"
    method: POST
    body: "{{ lookup('template','catalog_batch_upsert.j2') }}"
    body_format: json
    headers:
      Square-Version: "2022-03-16"
      Authorization: "Bearer {{ sqaure_access_token }}"
      Content-Type: "application/json"
  become: yes
  tags: upsert

- name: Git checkout
  ansible.builtin.git:
    repo: "{{ repo }}"
    dest: "{{ repo_dir }}"
    version: main
    force: yes
  tags: checkout

- name: Empty items dir
  file:
    path: "{{ items_dir }}"
    state: "absent"

- name: Side load image assets
  copy:
    src: "items"
    dest: "{{ images_dir }}"

- name: Side load image metadata
  template:
    src: "products.service.ts.j2"
    dest: "{{ app_dir }}products.service.ts"

- name: Ensure image processing script exists
  template:
    src: "image_processing.sh.j2"
    dest: "{{ items_dir }}image_processing.sh"
    mode: a+x

- name: Disable webserver during build
  service:
    name: "nginx"
    state: stopped

- name: process images
  shell: "cd {{ items_dir }} && ./image_processing.sh"

- name: install project dependencies
  shell: "cd {{ repo_dir }} && npm install --force"

- name: build production artifacts
  shell: "cd {{ repo_dir }} && ng build --prod"

- name: Create empty nginx web directory
  file:
    path: "{{ web_dir }}"
    state: "{{ item }}"
  with_items:
    - absent
    - directory

- name: Place production artifacts
  shell: "cp -R {{ artifact_build_dir }}. {{ web_dir }}"
  notify: restart nginx
